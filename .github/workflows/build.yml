name: Build and Release

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64 with GUI
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            features: gui
            artifact_name: lyssa_rds_gen-windows-x64-gui.exe
          # Windows x64 with TUI
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            features: tui
            artifact_name: lyssa_rds_gen-windows-x64-tui.exe
          # Windows x64 with all features
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            features: "gui,tui"
            artifact_name: lyssa_rds_gen-windows-x64-full.exe
          # Linux x64 musl with GUI (static)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            features: gui
            artifact_name: lyssa_rds_gen-linux-x64-musl-gui
          # Linux x64 musl with TUI (static)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            features: tui
            artifact_name: lyssa_rds_gen-linux-x64-musl-tui
          # Linux x64 musl with all features (static)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            features: "gui,tui"
            artifact_name: lyssa_rds_gen-linux-x64-musl-full
          # Linux x64 gnu with GUI
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            features: gui
            artifact_name: lyssa_rds_gen-linux-x64-gnu-gui
          # Linux x64 gnu with TUI
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            features: tui
            artifact_name: lyssa_rds_gen-linux-x64-gnu-tui
          # Linux x64 gnu with all features
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            features: "gui,tui"
            artifact_name: lyssa_rds_gen-linux-x64-gnu-full

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install musl-tools (Linux)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Build for Windows
      if: contains(matrix.os, 'windows')
      run: |
        cargo build --target ${{ matrix.target }} --release --features "${{ matrix.features }}" --locked

    - name: Build for Linux
      if: contains(matrix.os, 'ubuntu')
      run: |
        cargo build --target ${{ matrix.target }} --release --features "${{ matrix.features }}" --locked

    - name: Rename binary (Windows)
      if: contains(matrix.os, 'windows')
      run: |
        Move-Item "target/${{ matrix.target }}/release/lyssa_rds_gen.exe" "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"

    - name: Rename binary (Linux)
      if: contains(matrix.os, 'ubuntu')
      run: |
        mv "target/${{ matrix.target }}/release/lyssa_rds_gen" "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
        chmod +x "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded files
      run: find . -type f -executable -o -name "*.exe" | sort

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ vars.CURRENT_VERSION || '1.0.0' }}
        name: Release ${{ vars.CURRENT_VERSION || '1.0.0' }}
        draft: false
        prerelease: false
        files: |
          **/lyssa_rds_gen-*
        generate_release_notes: true
